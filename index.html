<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>Internet Locator (AMOLED)</title>

  <style>
    :root{
      --bg:#000;
      --bg2:#050507;
      --card:#0b0b10;
      --card2:#0f0f18;
      --text:#e9e9ef;
      --muted:#9aa0aa;
      --line:#1f2230;
      --accent:#6be3ff;
      --good:#43ff8f;
      --warn:#ffd166;
      --bad:#ff4d6d;
      --shadow: 0 10px 25px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 50% -10%, rgba(107,227,255,.12), transparent 55%),
        radial-gradient(800px 600px at 90% 10%, rgba(67,255,143,.08), transparent 50%),
        radial-gradient(900px 700px at 10% 20%, rgba(255,77,109,.08), transparent 55%),
        linear-gradient(var(--bg), var(--bg2));
      color:var(--text);
      font: 15px/1.35 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
    }
    .wrap{max-width:980px;margin:0 auto;display:grid;gap:12px;}
    .top{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 6px 0 6px;}
    .brand{display:flex; flex-direction:column; gap:2px;}
    .brand b{font-size:18px; letter-spacing:.2px}
    .brand small{color:var(--muted)}
    .pill{
      display:flex; gap:8px; align-items:center;
      padding:9px 12px; border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:999px;
      box-shadow: var(--shadow);
      color:var(--muted);
      user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--warn);box-shadow:0 0 0 4px rgba(255,209,102,.12);}
    .dot.ok{background:var(--good); box-shadow:0 0 0 4px rgba(67,255,143,.12);}
    .dot.bad{background:var(--bad); box-shadow:0 0 0 4px rgba(255,77,109,.12);}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:12px;}
    @media (max-width:920px){ .grid{grid-template-columns:1fr;} }

    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border-radius:var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(15,15,24,.85), rgba(10,10,16,.45));
    }
    .card .hd h2{margin:0; font-size:14px; letter-spacing:.3px; color:var(--muted); font-weight:700; text-transform:uppercase;}
    .card .bd{padding:14px;}
    .row{display:flex; gap:10px; flex-wrap:wrap;}
    .btn{
      appearance:none; border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:11px 12px;
      border-radius:14px;
      display:inline-flex; align-items:center; gap:8px;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
    }
    .btn:active{transform: scale(.985);}
    .btn.primary{border-color: rgba(107,227,255,.35); background: rgba(107,227,255,.08);}
    .btn.good{border-color: rgba(67,255,143,.35); background: rgba(67,255,143,.08);}
    .btn.bad{border-color: rgba(255,77,109,.35); background: rgba(255,77,109,.08);}
    .btn.ghost{background:transparent;}
    .btn:disabled{opacity:.45; cursor:not-allowed;}
    .kbd{
      font: 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      color:var(--muted);
      border:1px solid var(--line);
      border-bottom-color:#0c0c14;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(255,255,255,.02);
    }

    .stats{display:grid;grid-template-columns: repeat(3, 1fr);gap:10px;margin-top:12px;}
    @media (max-width:520px){ .stats{grid-template-columns:1fr;} }
    .stat{border:1px solid var(--line);background:linear-gradient(180deg, rgba(15,15,24,.6), rgba(8,8,12,.35));border-radius:16px;padding:10px 12px;}
    .stat .k{color:var(--muted); font-size:12px;}
    .stat .v{font-size:18px; font-weight:800; margin-top:4px;}
    .stat .s{color:var(--muted); font-size:12px; margin-top:2px;}

    .compassWrap{display:grid; grid-template-columns: 1fr 1fr; gap:12px;align-items:stretch;}
    @media (max-width:520px){ .compassWrap{grid-template-columns:1fr;} }
    .compass{
      border:1px solid var(--line);
      background:radial-gradient(240px 240px at 50% 35%, rgba(107,227,255,.10), rgba(0,0,0,.0) 60%),
                 linear-gradient(180deg, rgba(15,15,24,.55), rgba(8,8,12,.35));
      border-radius:16px;
      padding:12px;
      position:relative;
      overflow:hidden;
      min-height:220px;
      display:flex; flex-direction:column;
      justify-content:space-between;
    }
    .dial{
      position:relative;width:170px;height:170px;margin:6px auto 2px auto;border-radius:50%;
      border:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(circle at 50% 50%, rgba(255,255,255,.05), transparent 60%),
        conic-gradient(from 0deg, rgba(107,227,255,.25), rgba(67,255,143,.08), rgba(255,77,109,.10), rgba(107,227,255,.25));
      box-shadow: inset 0 0 0 10px rgba(0,0,0,.35), 0 14px 24px rgba(0,0,0,.55);
    }
    .needle{
      position:absolute;left:50%; top:50%;
      width:4px; height:72px;
      transform-origin: 50% 92%;
      transform: translate(-50%,-92%) rotate(0deg);
      background: linear-gradient(180deg, var(--accent), rgba(107,227,255,.0));
      border-radius:999px;
      filter: drop-shadow(0 6px 10px rgba(107,227,255,.35));
    }
    .needle::after{
      content:"";
      position:absolute;left:50%; top:-10px;transform:translateX(-50%);
      width:14px;height:14px;border-radius:50%;
      background: rgba(107,227,255,.22);
      border:1px solid rgba(107,227,255,.35);
      box-shadow:0 0 0 6px rgba(107,227,255,.10);
    }
    .dialLabel{text-align:center;color:var(--muted);margin-top:6px;font-size:12px;}
    .big{font-size:22px; font-weight:900;letter-spacing:.2px;}
    .sub{color:var(--muted);font-size:12px;margin-top:2px;}

    .list{border:1px solid var(--line);border-radius:16px;overflow:hidden;background:linear-gradient(180deg, rgba(15,15,24,.6), rgba(8,8,12,.35));}
    .listHead{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);color:var(--muted);font-size:12px;}
    .items{max-height:320px; overflow:auto;}
    .item{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;gap:10px;align-items:flex-start;}
    .item:last-child{border-bottom:none;}
    .badge{
      font-weight:800;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);
      color:var(--text);background:rgba(255,255,255,.03);white-space:nowrap;
    }
    .badge.good{border-color: rgba(67,255,143,.35); background: rgba(67,255,143,.08);}
    .badge.warn{border-color: rgba(255,209,102,.35); background: rgba(255,209,102,.08);}
    .badge.bad{border-color: rgba(255,77,109,.35); background: rgba(255,77,109,.08);}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
    .log{
      height:190px; overflow:auto;border:1px solid var(--line);background:rgba(0,0,0,.35);
      border-radius:16px;padding:10px;color:#cfd3dd;font-size:12px;line-height:1.35;
    }
    .hint{color:var(--muted);font-size:12px;margin-top:10px;}
    .sep{height:10px;}
    .footer{color:var(--muted);text-align:center;font-size:12px;padding:10px 0 4px 0;}
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <b>Internet Locator</b>
        <small>AMOLED ‚Ä¢ Smart scan ‚Ä¢ ‚Äú–ô–¥–∏ —Ç—É–¥–∏, –¥–µ –∫—Ä–∞—â–µ —Ç—è–≥–Ω–µ‚Äù</small>
      </div>
      <div class="pill" id="statusPill">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">–ì–æ—Ç–æ–≤–∏–π</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">
          <h2>–ö–µ—Ä—É–≤–∞–Ω–Ω—è</h2>
          <div class="mono" style="color:var(--muted);font-size:12px;">v3 AMOLED</div>
        </div>
        <div class="bd">
          <div class="row">
            <button class="btn primary" id="btnCompass">üß≠ –î–æ–∑–≤–æ–ª–∏—Ç–∏ –∫–æ–º–ø–∞—Å</button>
            <button class="btn good" id="btnStart">‚ñ∂Ô∏è Start Scan</button>
            <button class="btn bad" id="btnStop" disabled>‚èπ Stop</button>
            <button class="btn ghost" id="btnFix">üõ† Fix GPS/Permissions</button>
          </div>

          <div class="stats">
            <div class="stat">
              <div class="k">GPS</div>
              <div class="v" id="gpsState">‚Äî</div>
              <div class="s" id="gpsAcc">–¢–æ—á–Ω—ñ—Å—Ç—å: ‚Äî</div>
            </div>
            <div class="stat">
              <div class="k">–Ü–Ω—Ç–µ—Ä–Ω–µ—Ç (score)</div>
              <div class="v" id="scoreNow">‚Äî</div>
              <div class="s" id="netNow">ping: ‚Äî ‚Ä¢ down: ‚Äî</div>
            </div>
            <div class="stat">
              <div class="k">–ö—Ä–∞—â–∞ —Ç–æ—á–∫–∞</div>
              <div class="v" id="bestScore">‚Äî</div>
              <div class="s" id="bestMeta">–≤—ñ–¥—Å—Ç–∞–Ω—å: ‚Äî</div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="compassWrap">
            <div class="compass">
              <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
                <div>
                  <div class="big" id="headingTxt">‚Äî¬∞</div>
                  <div class="sub">–ù–∞–ø—Ä—è–º–æ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω—É (–∑–≥–ª–∞–¥–∂–µ–Ω–æ)</div>
                </div>
                <div class="kbd" id="compassState">–∫–æ–º–ø–∞—Å: ‚Äî</div>
              </div>

              <div class="dial">
                <div class="needle" id="needle"></div>
              </div>
              <div class="dialLabel" id="arrowTxt">–°—Ç—Ä—ñ–ª–∫–∞ –ø–æ–∫–∞–∂–µ –Ω–∞–ø—Ä—è–º–æ–∫ –Ω–∞ –Ω–∞–π–∫—Ä–∞—â—É —Ç–æ—á–∫—É</div>
            </div>

            <div class="list">
              <div class="listHead">
                <span>–¢–æ—á–∫–∏ —Å–∫–∞–Ω—É</span>
                <span class="mono" id="pointsCount">0</span>
              </div>
              <div class="items" id="pointsList"></div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <button class="btn" id="btnExport">‚¨áÔ∏è Export JSON</button>
            <button class="btn" id="btnImport">‚¨ÜÔ∏è Import JSON</button>
            <button class="btn" id="btnClear">üóë Clear</button>
          </div>

          <div class="hint">
            iPhone: –≤—ñ–¥–∫—Ä–∏–≤–∞–π —É Safari —Ç–∞ –¥–æ–∑–≤–æ–ª—è–π <b>–†–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è</b> ‚Äú–ü—ñ–¥ —á–∞—Å –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è‚Äù.
            –ö–æ–º–ø–∞—Å –ø—Ä–æ—Å–∏—Ç—å –¥–æ–∑–≤—ñ–ª –∫–Ω–æ–ø–∫–æ—é.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>–õ–æ–≥ —ñ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h2>
          <div class="kbd" id="scanState">scan: idle</div>
        </div>
        <div class="bd">
          <div class="log mono" id="log"></div>
          <div class="sep"></div>
          <div class="hint">
            <b>Score</b> = latency + stability + –º–∞–ª–µ–Ω—å–∫–∏–π download. –ù–∞ —Å–ª–∞–±–∫–æ–º—É —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—ñ —Ç–µ—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ ‚Äú–ø–æ–ª–µ–≥—à—É—î—Ç—å—Å—è‚Äù.
          </div>
          <div class="footer">
            –ü–æ—Ä–∞–¥–∞: —Ä—É—Ö–∞–π—Å—è –ø–æ –∫—ñ–º–Ω–∞—Ç—ñ/–¥–≤–æ—Ä—É –ø–æ–≤—ñ–ª—å–Ω–æ ‚Äî —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ –∑–∞–ø–∞–º‚Äô—è—Ç–∞—î –Ω–∞–π–∫—Ä–∞—â—ñ —Ç–æ—á–∫–∏.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const now = () => new Date().toTimeString().slice(0,8);
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const rad = (d) => d * Math.PI / 180;
  const deg = (r) => r * 180 / Math.PI;

  function haversine(a, b){
    const R = 6371000;
    const dLat = rad(b.lat - a.lat);
    const dLon = rad(b.lon - a.lon);
    const s1 = Math.sin(dLat/2), s2 = Math.sin(dLon/2);
    const q = s1*s1 + Math.cos(rad(a.lat))*Math.cos(rad(b.lat))*s2*s2;
    return 2 * R * Math.asin(Math.sqrt(q));
  }
  function bearing(from, to){
    const œÜ1 = rad(from.lat), œÜ2 = rad(to.lat);
    const Œª1 = rad(from.lon), Œª2 = rad(to.lon);
    const y = Math.sin(Œª2-Œª1)*Math.cos(œÜ2);
    const x = Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(Œª2-Œª1);
    return (deg(Math.atan2(y, x)) + 360) % 360;
  }

  const statusDot = $("statusDot");
  const statusText = $("statusText");
  const gpsState = $("gpsState");
  const gpsAcc = $("gpsAcc");
  const scoreNow = $("scoreNow");
  const netNow = $("netNow");
  const bestScore = $("bestScore");
  const bestMeta = $("bestMeta");
  const pointsCount = $("pointsCount");
  const pointsList = $("pointsList");
  const headingTxt = $("headingTxt");
  const needle = $("needle");
  const arrowTxt = $("arrowTxt");
  const logEl = $("log");
  const compassState = $("compassState");
  const scanState = $("scanState");

  const btnCompass = $("btnCompass");
  const btnStart = $("btnStart");
  const btnStop = $("btnStop");
  const btnFix = $("btnFix");
  const btnExport = $("btnExport");
  const btnImport = $("btnImport");
  const btnClear = $("btnClear");

  function log(msg){
    const line = `[${now()}] ${msg}`;
    const div = document.createElement("div");
    div.textContent = line;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }
  function setStatus(kind, text){
    statusDot.classList.remove("ok","bad");
    if(kind==="ok") statusDot.classList.add("ok");
    else if(kind==="bad") statusDot.classList.add("bad");
    statusText.textContent = text;
  }

  const LS_KEY = "internet_locator_points_v3";
  let points = [];
  let scanning = false;

  let pos = null;
  let accMeters = 9999;
  let watchId = null;

  let compassAllowed = false;
  let headingSmooth = null;
  let lastNeedleDeg = 0;

  let best = null;
  let loopTimer = null;

  let lastSampleAt = 0;
  let lastSamplePos = null;
  let weakMode = false; // auto based on ping/down

  const CFG = {
    minAccMeters: 55,
    sampleEveryMs: 3500,
    sampleMinMove: 9,
    maxPoints: 120,

    pingTries: 3,
    pingTimeoutMs: 1400,
    dlTimeoutMs: 2400,
    dlBytesStrong: 220*1024,
    dlBytesWeak: 80*1024,

    pingUrls: [
      "https://www.cloudflare.com/cdn-cgi/trace",
      "https://www.google.com/generate_204"
    ],
    dlUrl: "https://cdn.jsdelivr.net/gh/jquery/jquery@3.7.1/dist/jquery.min.js"
  };

  function save(){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(points)); } catch(e){}
  }
  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      points = raw ? JSON.parse(raw) : [];
      if(!Array.isArray(points)) points = [];
    }catch(e){ points = []; }
  }

  function scoreClass(score){
    if(score>=75) return "good";
    if(score>=45) return "warn";
    return "bad";
  }

  function renderPoints(){
    pointsCount.textContent = String(points.length);
    pointsList.innerHTML = "";

    const sorted = [...points].sort((a,b)=>b.score-a.score).slice(0, 30);
    for(const p of sorted){
      const it = document.createElement("div");
      it.className = "item";
      const left = document.createElement("div");
      left.innerHTML = `
        <div style="font-weight:800">${p.score.toFixed(0)} <span class="mono" style="color:var(--muted);font-weight:600">score</span></div>
        <div class="mono" style="color:var(--muted);font-size:12px;margin-top:2px;">
          ping ${Math.round(p.ping)}ms ‚Ä¢ jit ${Math.round(p.jitter)}ms ‚Ä¢ down ${p.downMbps.toFixed(2)} Mbps
        </div>
        <div class="mono" style="color:var(--muted);font-size:12px;margin-top:2px;">
          acc ¬±${Math.round(p.acc)}m ‚Ä¢ ${new Date(p.t).toLocaleTimeString().slice(0,5)}
        </div>
      `;
      const badge = document.createElement("div");
      badge.className = "badge " + scoreClass(p.score);
      badge.textContent = (p.score>=75)?"TOP":(p.score>=45)?"OK":"LOW";
      it.appendChild(left);
      it.appendChild(badge);
      pointsList.appendChild(it);
    }
  }

  function recomputeBest(){
    if(!points.length){ best=null; bestScore.textContent="‚Äî"; bestMeta.textContent="–≤—ñ–¥—Å—Ç–∞–Ω—å: ‚Äî"; return; }
    let bestP=null, bestVal=-1e9;
    for(const p of points){
      const stabPenalty = (p.jitter*0.6) + (p.fail?12:0) + (p.acc>CFG.minAccMeters?6:0);
      const val = p.score - stabPenalty;
      if(val>bestVal){ bestVal=val; bestP=p; }
    }
    best = bestP;
    bestScore.textContent = best.score.toFixed(0);
    updateBestDistance();
    updateArrow();
  }

  function updateBestDistance(){
    if(!best || !pos){ bestMeta.textContent="–≤—ñ–¥—Å—Ç–∞–Ω—å: ‚Äî"; return; }
    const d = haversine(pos, best);
    bestMeta.textContent = `–≤—ñ–¥—Å—Ç–∞–Ω—å: ${d<1000 ? Math.round(d)+' –º' : (d/1000).toFixed(2)+' –∫–º'}`;
  }

  function updateArrow(){
    if(headingSmooth == null){
      needle.style.transform = `translate(-50%,-92%) rotate(${lastNeedleDeg}deg)`;
      headingTxt.textContent = "‚Äî¬∞";
      arrowTxt.textContent = "–î–∞–π –¥–æ–∑–≤—ñ–ª –∫–æ–º–ø–∞—Å—É";
      return;
    }
    headingTxt.textContent = `${Math.round(headingSmooth)}¬∞`;

    if(!best || !pos){
      arrowTxt.textContent = "–°—Ç—Ä—ñ–ª–∫–∞ –ø–æ–∫–∞–∂–µ –Ω–∞–ø—Ä—è–º–æ–∫ –Ω–∞ –Ω–∞–π–∫—Ä–∞—â—É —Ç–æ—á–∫—É";
      return;
    }

    const brg = bearing(pos, best);
    const rel = (brg - headingSmooth + 360) % 360;
    lastNeedleDeg = rel;
    needle.style.transform = `translate(-50%,-92%) rotate(${rel}deg)`;

    const d = haversine(pos, best);
    arrowTxt.textContent = `–ô–¥–∏ ${Math.round(rel)}¬∞ ‚Üí –¥–æ –∫—Ä–∞—â–æ—ó —Ç–æ—á–∫–∏ (${d<1000?Math.round(d)+" –º":(d/1000).toFixed(2)+" –∫–º"})`;
  }

  async function requestCompass(){
    try{
      if(typeof DeviceOrientationEvent === "undefined"){
        compassState.textContent = "–∫–æ–º–ø–∞—Å: –Ω–µ–º–∞";
        log("‚ùå –ù–µ–º–∞—î DeviceOrientationEvent.");
        setStatus("bad","–ù–µ–º–∞ –∫–æ–º–ø–∞—Å–∞");
        return;
      }
      if(typeof DeviceOrientationEvent.requestPermission === "function"){
        const res = await DeviceOrientationEvent.requestPermission();
        if(res !== "granted"){
          compassAllowed = false;
          compassState.textContent = "–∫–æ–º–ø–∞—Å: denied";
          log("‚ùå –ö–æ–º–ø–∞—Å –Ω–µ –¥–æ–∑–≤–æ–ª–µ–Ω–æ.");
          setStatus("bad","–ö–æ–º–ø–∞—Å denied");
          return;
        }
      }
      compassAllowed = true;
      compassState.textContent = "–∫–æ–º–ø–∞—Å: ok";
      log("‚úÖ –ö–æ–º–ø–∞—Å –¥–æ–∑–≤–æ–ª–µ–Ω–æ.");
      setStatus("ok","–ö–æ–º–ø–∞—Å OK");
    }catch(e){
      compassAllowed = false;
      compassState.textContent = "–∫–æ–º–ø–∞—Å: error";
      log("‚ùå Compass error: " + (e?.message||e));
      setStatus("bad","–ö–æ–º–ø–∞—Å error");
    }
  }

  window.addEventListener("deviceorientation", (ev) => {
    if(!compassAllowed) return;

    let h = null;
    if(typeof ev.webkitCompassHeading === "number"){
      h = ev.webkitCompassHeading;
    }else if(typeof ev.alpha === "number"){
      h = (360 - ev.alpha) % 360;
    }
    if(h == null) return;

    if(headingSmooth == null) headingSmooth = h;
    else{
      const a = 0.18;
      let diff = ((h - headingSmooth + 540) % 360) - 180;
      headingSmooth = (headingSmooth + diff * a + 360) % 360;
    }
    updateArrow();
  }, {passive:true});

  function startGPS(){
    if(!("geolocation" in navigator)){
      log("‚ùå Geolocation –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è.");
      gpsState.textContent = "–Ω–µ–º–∞";
      setStatus("bad","–ù–µ–º–∞ GPS API");
      return;
    }
    if(watchId != null) navigator.geolocation.clearWatch(watchId);

    watchId = navigator.geolocation.watchPosition(
      (p) => {
        pos = { lat: p.coords.latitude, lon: p.coords.longitude };
        accMeters = p.coords.accuracy ?? 9999;

        gpsAcc.textContent = `–¢–æ—á–Ω—ñ—Å—Ç—å: ¬±${Math.round(accMeters)} –º`;
        gpsState.textContent = (accMeters <= CFG.minAccMeters) ? "OK" : "—Å–ª–∞–±–∫–æ";

        if(accMeters <= CFG.minAccMeters) setStatus("ok","GPS OK");
        else setStatus("", "GPS —Å–ª–∞–±–∫–∏–π");

        updateBestDistance();
        updateArrow();
      },
      (err) => {
        log(`‚ùå Geo error: ${err.message || err.code}`);
        gpsState.textContent = "DENIED";
        setStatus("bad","GPS denied");
      },
      { enableHighAccuracy:true, maximumAge:1500, timeout:12000 }
    );
  }

  function randStr(n=10){
    const a = "abcdefghijklmnopqrstuvwxyz0123456789";
    let s=""; for(let i=0;i<n;i++) s+=a[(Math.random()*a.length)|0];
    return s;
  }
  async function fetchWithTimeout(url, opts={}, ms=1200){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), ms);
    try{
      return await fetch(url, { ...opts, signal: ctrl.signal, cache:"no-store" });
    } finally { clearTimeout(t); }
  }

  async function measurePing(){
    const samples = [];
    let fails = 0;

    for(let i=0;i<CFG.pingTries;i++){
      const base = CFG.pingUrls[i % CFG.pingUrls.length];
      const url = base + (base.includes("?") ? "&" : "?") + "r=" + randStr(8);
      const t0 = performance.now();
      try{
        await fetchWithTimeout(url, { method:"GET", mode:"cors" }, CFG.pingTimeoutMs);
        const t1 = performance.now();
        samples.push(t1 - t0);
      }catch(e){ fails++; }
    }

    if(!samples.length) return { ping: 999, jitter: 250, fail:true };
    samples.sort((a,b)=>a-b);
    const ping = samples[Math.floor(samples.length/2)];
    let jitter = 0;
    for(let i=1;i<samples.length;i++) jitter += Math.abs(samples[i]-samples[i-1]);
    jitter = (samples.length>1) ? (jitter/(samples.length-1)) : 0;
    return { ping, jitter, fail: fails>0 };
  }

  async function measureDownload(isWeak){
    const bytes = isWeak ? CFG.dlBytesWeak : CFG.dlBytesStrong;
    const url = CFG.dlUrl + "?r=" + randStr(6);
    const t0 = performance.now();
    let got = 0;
    try{
      const r = await fetchWithTimeout(url, { method:"GET", mode:"cors" }, CFG.dlTimeoutMs);
      const reader = r.body?.getReader?.();
      if(!reader) throw new Error("no stream");
      while(true){
        const {done, value} = await reader.read();
        if(done) break;
        got += value.byteLength;
        if(got >= bytes) break;
      }
    }catch(e){
      return { downMbps: 0, dlMs: CFG.dlTimeoutMs, fail:true };
    }
    const t1 = performance.now();
    const ms = Math.max(1, t1 - t0);
    const mbps = (got * 8) / (ms/1000) / 1e6;
    return { downMbps: mbps, dlMs: ms, fail:false };
  }

  function computeScore(ping, jitter, downMbps, anyFail){
    const pingScore = clamp(100 - (ping * 0.22), 0, 100);
    const jitScore  = clamp(100 - (jitter * 0.65), 0, 100);
    const downScore = clamp(Math.log2(1 + downMbps) * 20, 0, 100);
    let score = pingScore * 0.55 + jitScore * 0.25 + downScore * 0.20;
    if(anyFail) score -= 8;
    return clamp(score, 0, 100);
  }

  function shouldSample(){
    const t = Date.now();
    if(!pos) return false;

    if(t - lastSampleAt < CFG.sampleEveryMs) {
      if(!lastSamplePos) return false;
      const d = haversine(pos, lastSamplePos);
      return d >= CFG.sampleMinMove;
    }
    return true;
  }

  function pushPoint(p){
    points.push(p);
    if(points.length > CFG.maxPoints){
      // keep best points + some newest
      points.sort((a,b)=>b.score-a.score);
      const bestKeep = points.slice(0, 80);
      const newest = points.slice(-20);
      const merged = [...bestKeep, ...newest];
      // unique by time+coords
      const m = new Map();
      for(const x of merged){
        const k = `${Math.round(x.lat*1e6)}:${Math.round(x.lon*1e6)}:${x.t}`;
        if(!m.has(k)) m.set(k, x);
      }
      points = Array.from(m.values());
      points.sort((a,b)=>a.t-b.t);
      points = points.slice(-CFG.maxPoints);
    }
    save();
    renderPoints();
    recomputeBest();
  }

  async function runOneSample(){
    if(!pos){
      log("‚è≥ –ß–µ–∫–∞—é GPS‚Ä¶");
      return;
    }

    const acc = accMeters;

    // If accuracy is very bad, still test, but mark it (you can still find ‚Äúbest corner‚Äù in building)
    const accPenalty = (acc > CFG.minAccMeters) ? " (acc weak)" : "";

    scanState.textContent = "scan: testing‚Ä¶";
    const p1 = await measurePing();

    // auto weakMode: if ping huge or fail ‚Äî switch to smaller download
    weakMode = p1.fail || p1.ping > 220;

    const dl = await measureDownload(weakMode);
    const anyFail = p1.fail || dl.fail;

    const score = computeScore(p1.ping, p1.jitter, dl.downMbps, anyFail);

    scoreNow.textContent = score.toFixed(0);
    netNow.textContent = `ping: ${Math.round(p1.ping)}ms ‚Ä¢ jit: ${Math.round(p1.jitter)}ms ‚Ä¢ down: ${dl.downMbps.toFixed(2)} Mbps${weakMode?" ‚Ä¢ weak":""}`;

    const point = {
      t: Date.now(),
      lat: pos.lat,
      lon: pos.lon,
      acc,
      ping: p1.ping,
      jitter: p1.jitter,
      downMbps: dl.downMbps,
      score,
      fail: anyFail
    };

    pushPoint(point);

    log(`üìç + point: score ${score.toFixed(0)} | ping ${Math.round(p1.ping)}ms | down ${dl.downMbps.toFixed(2)} Mbps${accPenalty}`);
    scanState.textContent = "scan: running";
    setStatus("ok", "–°–∫–∞–Ω –ø—Ä–∞—Ü—é—î");
    lastSampleAt = Date.now();
    lastSamplePos = { ...pos };
  }

  function startScan(){
    if(scanning) return;
    scanning = true;
    btnStart.disabled = true;
    btnStop.disabled = false;
    scanState.textContent = "scan: running";
    log("‚ñ∂Ô∏è Start Scan");

    startGPS();

    const loop = async () => {
      if(!scanning) return;
      try{
        if(shouldSample()) await runOneSample();
      }catch(e){
        log("‚ùå Scan error: " + (e?.message||e));
        setStatus("bad","Scan error");
      }finally{
        if(scanning) loopTimer = setTimeout(loop, CFG.sampleEveryMs);
      }
    };
    loop();
  }

  function stopScan(){
    if(!scanning) return;
    scanning = false;
    btnStart.disabled = false;
    btnStop.disabled = true;
    scanState.textContent = "scan: idle";
    log("‚èπ Stop");
    setStatus("", "–ó—É–ø–∏–Ω–µ–Ω–æ");

    if(loopTimer) clearTimeout(loopTimer);
    loopTimer = null;
  }

  function fixHelp(){
    log("üõ† Fix: —è–∫—â–æ GPS denied ‚Äî iPhone Settings ‚Üí Privacy ‚Üí Location Services ‚Üí Safari Websites ‚Üí While Using.");
    log("üõ† Fix: Safari ‚Üí AA ‚Üí Website Settings ‚Üí Location ‚Üí Allow.");
    log("üõ† Fix: —è–∫—â–æ –∫–æ–º–ø–∞—Å –Ω–µ –ø—Ä–∞—Ü—é—î ‚Äî –Ω–∞—Ç–∏—Å–Ω–∏ '–î–æ–∑–≤–æ–ª–∏—Ç–∏ –∫–æ–º–ø–∞—Å' —ñ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏.");
    alert(
      "Fix GPS/Permissions:\n\n" +
      "1) iPhone: Settings ‚Üí Privacy & Security ‚Üí Location Services ‚Üí ON\n" +
      "2) –¢–∞–º –∂–µ: Safari Websites ‚Üí While Using (+ Precise)\n" +
      "3) Safari: AA ‚Üí Website Settings ‚Üí Location ‚Üí Allow\n" +
      "4) –ö–æ–º–ø–∞—Å: –Ω–∞—Ç–∏—Å–Ω–∏ –∫–Ω–æ–ø–∫—É '–î–æ–∑–≤–æ–ª–∏—Ç–∏ –∫–æ–º–ø–∞—Å'\n\n" +
      "–ü–æ—Ç—ñ–º –æ–Ω–æ–≤–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É —ñ –Ω–∞—Ç–∏—Å–Ω–∏ Start Scan."
    );
  }

  function exportJSON(){
    const data = JSON.stringify({ v:3, points }, null, 2);
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "internet-locator-points.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
    log("‚¨áÔ∏è Export JSON");
  }

  function importJSON(){
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "application/json";
    inp.onchange = async () => {
      const f = inp.files?.[0];
      if(!f) return;
      const txt = await f.text();
      try{
        const obj = JSON.parse(txt);
        if(obj && Array.isArray(obj.points)){
          points = obj.points.filter(p => p && typeof p.lat==="number" && typeof p.lon==="number" && typeof p.score==="number");
          save();
          renderPoints();
          recomputeBest();
          log("‚¨ÜÔ∏è Import JSON: OK ("+points.length+")");
        }
          function importJSON(){
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "application/json";
    inp.onchange = async () => {
      const f = inp.files?.[0];
      if(!f) return;
      const txt = await f.text();
      try{
        const obj = JSON.parse(txt);
        if(obj && Array.isArray(obj.points)){
          points = obj.points.filter(p =>
            p && typeof p.lat==="number" && typeof p.lon==="number" &&
            typeof p.score==="number" && typeof p.t==="number"
          );
          save();
          renderPoints();
          recomputeBest();
          log(`‚¨ÜÔ∏è Import JSON: OK (${points.length})`);
          setStatus("ok","Import OK");
        } else {
          log("‚ùå Import: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç JSON (–Ω–µ–º–∞ points[])");
          setStatus("bad","Import fail");
          alert("–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–∞–π–ª. –û—á—ñ–∫—É—é JSON –∑ –ø–æ–ª–µ–º points[]");
        }
      }catch(e){
        log("‚ùå Import JSON error: " + (e?.message||e));
        setStatus("bad","Import error");
        alert("–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è JSON: " + (e?.message||e));
      }
    };
    inp.click();
  }

  function clearAll(){
    if(!confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ç–æ—á–∫–∏?")) return;
    points = [];
    save();
    renderPoints();
    recomputeBest();
    log("üóë Clear: points removed");
    setStatus("", "–û—á–∏—â–µ–Ω–æ");
  }

  // ===== UI wiring =====
  btnCompass.addEventListener("click", requestCompass);
  btnStart.addEventListener("click", startScan);
  btnStop.addEventListener("click", stopScan);
  btnFix.addEventListener("click", fixHelp);
  btnExport.addEventListener("click", exportJSON);
  btnImport.addEventListener("click", importJSON);
  btnClear.addEventListener("click", clearAll);

  // ===== Boot =====
  load();
  renderPoints();
  recomputeBest();
  updateArrow();
  startGPS(); // –æ–¥—Ä–∞–∑—É –ø—Ä–æ—Å–∏–º–æ GPS (—â–æ–± –Ω–µ —á–µ–∫–∞—Ç–∏ –ø—Ä–∏ Start)
  log("–ì–æ—Ç–æ–≤–æ. –ù–∞—Ç–∏—Å–Ω–∏ '–î–æ–∑–≤–æ–ª–∏—Ç–∏ –∫–æ–º–ø–∞—Å' —ñ 'Start Scan'.");
})();
</script>
</body>
</html>
